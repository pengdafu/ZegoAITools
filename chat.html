<!DOCTYPE html>
<html>
<head>
    <title>高级聊天对话</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/styles/default.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
    <style>
        #chatbox {
            height: 400px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: scroll;
        }

        #user-input {
            width: 80%;
        }

        .message {
            margin-bottom: 10px;
        }

        .question {
            color: blue;
        }

        .answer {
            color: green;
        }






    </style>
    <meta charset="UTF-8">
</head>
<body>
<div id="chatbox">
</div>

<input id="user-input" type="text" placeholder="在此输入">
<button id="send-button">发送</button>

<script>
        // 配置 marked
        marked.setOptions({
            renderer: new marked.Renderer(),
            highlight: function(code, lang) {
                return hljs.highlightAuto(code, [lang]).value;
            },
            langPrefix: 'hljs',
            breaks: true,
            gfm: true,
            tables: true,
            smartLists: true,
            smartypants: true,
        });

        // 配置 mermaid
        mermaid.initialize({
            startOnLoad: true,
        });

        document.getElementById('send-button').addEventListener('click', function() {
            const userInput = document.getElementById('user-input');
            const chatbox = document.getElementById('chatbox');

            const userQuestion = document.createElement('div');
            userQuestion.classList.add('message', 'question');
            userQuestion.innerHTML = marked.parse(userInput.value);
            chatbox.appendChild(userQuestion);
            userInput.value = '';

            // TODO: 在这里调用你的对话机器人API，获取回答
            const botAnswer = '# 标题1\n为什么\n```go\nfmt.Println(123)\n```';  // 假设机器人的回答

            const botAnswerElement = document.createElement('div');
            botAnswerElement.classList.add('message', 'answer');
            botAnswerElement.innerHTML = marked.parse(botAnswer);
            chatbox.appendChild(botAnswerElement);

            // 渲染公式
            Array.from(botAnswerElement.getElementsByClassName('katex')).forEach(function(element) {
                katex.render(element.textContent, element, {
                    throwOnError: false,
                });
            });

            // 渲染 mermaid 图表
            Array.from(botAnswerElement.getElementsByClassName('mermaid')).forEach(function(element) {
                mermaid.render('graphDiv', element.textContent, function(svgCode) {
                    element.innerHTML = svgCode;
                });
            });

            // 滚动到底部
            chatbox.scrollTop = chatbox.scrollHeight;
        });

        // EventSource 用于接收服务器的实时更新
        var source = new EventSource("path_to_your_server");
        source.onmessage = function(event) {
            const chatbox = document.getElementById('chatbox');
            const botAnswerElement = document.createElement('div');
            botAnswerElement.classList.add('message', 'answer');
            botAnswerElement.innerHTML = marked.parse(event.data);
            chatbox.appendChild(botAnswerElement);

            // 渲染公式
            Array.from(botAnswerElement.getElementsByClassName('katex')).forEach(function(element) {
                katex.render(element.textContent, element, {
                    throwOnError: false,
                });
            });

            // 渲染 mermaid 图表
            Array.from(botAnswerElement.getElementsByClassName('mermaid')).forEach(function(element) {
                mermaid.render('graphDiv', element.textContent, function(svgCode) {
                    element.innerHTML = svgCode;
                });
            });

            // 滚动到底部
            chatbox.scrollTop = chatbox.scrollHeight;
        };






</script>
</body>
</html>
